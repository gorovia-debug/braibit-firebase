<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BraiBit v5.0 - IES Luis Braille</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-slow{0%,100%{opacity:1}50%{opacity:.5}}.animate-pulse-slow{animation:pulse-slow 3s ease infinite}
        @keyframes glow{0%,100%{box-shadow:0 0 20px rgba(147,51,234,.3)}50%{box-shadow:0 0 40px rgba(147,51,234,.6)}}.animate-glow{animation:glow 2s ease infinite}
        ::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:rgba(0,0,0,.1)}::-webkit-scrollbar-thumb{background:rgba(147,51,234,.5);border-radius:4px}
        .tab-btn{transition:all .3s}.tab-btn.active{background:linear-gradient(135deg,#9333ea,#ec4899);color:#fff}
        .modal-backdrop{background:rgba(0,0,0,.8);backdrop-filter:blur(8px)}
        .card-hover:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(147,51,234,.2)}
        select{background-color:rgba(255,255,255,0.1);color:white}
        select option{background-color:#ffffff;color:#000000}
        .opt-btn{transition:all .2s;opacity:0.5;border:2px solid transparent}
        .opt-btn.active{opacity:1;border-color:white;transform:scale(1.02)}
        .sofa{background:linear-gradient(135deg,#22c55e,#16a34a)}
        .mochila{background:linear-gradient(135deg,#f59e0b,#d97706)}
        .escalada{background:linear-gradient(135deg,#ef4444,#dc2626)}
    </style>
</head>
<body class="bg-gradient-to-br from-slate-950 via-purple-950 to-slate-950 min-h-screen">
<div id="app"></div>
<script>
const firebaseConfig={apiKey:"AIzaSyCikAEptyqDRjUSdSgd7o6mxaFvfK91u-Y",authDomain:"moneda-social-4692b.firebaseapp.com",databaseURL:"https://moneda-social-4692b-default-rtdb.europe-west1.firebasedatabase.app",projectId:"moneda-social-4692b",storageBucket:"moneda-social-4692b.firebasestorage.app",messagingSenderId:"893005212499",appId:"1:893005212499:web:93cd8280422e43acb50fa6"};
if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const generateEthAddress=()=>{let a='0x';for(let i=0;i<40;i++)a+='0123456789abcdef'[Math.floor(Math.random()*16)];return a};
const generateTxHash=()=>{let h='0x';for(let i=0;i<64;i++)h+='0123456789abcdef'[Math.floor(Math.random()*16)];return h};
const formatAddr=a=>a?a.slice(0,6)+'...'+a.slice(-4):'';
const formatNum=n=>new Intl.NumberFormat('es-ES',{minimumFractionDigits:0,maximumFractionDigits:0}).format(n);
const formatDate=d=>new Date(d).toLocaleString('es-ES',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});
const BB='BB',NAME='BraiBit';

const TUTOR_GROUPS_BY_EMAIL={
'margarita@iesluisbraille.edu':['AD-1','AD-2'],
'miriam@iesluisbraille.edu':['CI-2'],
'ana@iesluisbraille.edu':['DAW-1'],
'elkin@iesluisbraille.edu':['DAW-1'],
'gonzalo@iesluisbraille.edu':['AC-1','AC-2'],
'rocio@iesluisbraille.edu':['AC-1','AC-2'],
'supervisor@iesluisbraille.edu':['AD-1','AD-2','DAW-1','AC-1','AC-2','CI-2']
};

const GROUP_COLORS={'AD-1':'#fbbf24','AD-2':'#60a5fa','DAW-1':'#34d399','AC-1':'#f472b6','AC-2':'#a78bfa','CI-2':'#fb923c'};

// TAREAS FIJAS (valor fijo)
const FIXED_TASKS=[
{id:'f1',name:'Limpiar espacios comunes',icon:'ğŸ§¹',bb:50,type:'fixed'},
{id:'f2',name:'MediaciÃ³n entre compaÃ±eros',icon:'ğŸ¤',bb:200,type:'fixed'},
{id:'f3',name:'TutorÃ­a entre compaÃ±eros',icon:'ğŸ‘¨â€ğŸ«',bb:100,type:'fixed'},
{id:'f4',name:'CreaciÃ³n material educativo',icon:'ğŸ“š',bb:120,type:'fixed'},
{id:'f5',name:'Organizar evento escolar',icon:'ğŸ‰',bb:200,type:'fixed'}
];

// TAREAS VARIABLES (requieren formulario SofÃ¡/Mochila/Escalada)
const VARIABLE_TASKS=[
{id:'v1',name:'Actividades OrientaciÃ³n',icon:'ğŸ§­',type:'variable'},
{id:'v2',name:'Agenda ODS',icon:'ğŸŒ',type:'variable'},
{id:'v3',name:'Aprendizaje Servicio',icon:'ğŸ¤²',type:'variable'},
{id:'v4',name:'SofÃ¡',icon:'ğŸ›‹ï¸',type:'variable'},
{id:'v5',name:'Mochila',icon:'ğŸ’',type:'variable'},
{id:'v6',name:'Escalada',icon:'ğŸ§—',type:'variable'}
];

// NIVELES
const LEVELS={
sofa:{name:'SofÃ¡',icon:'ğŸ›‹ï¸',min:25,max:50,color:'#22c55e'},
mochila:{name:'Mochila',icon:'ğŸ’',min:75,max:120,color:'#f59e0b'},
escalada:{name:'Escalada',icon:'ğŸ§—',min:150,max:200,color:'#ef4444'}
};

// CRITERIOS para calcular nivel
const CRITERIA={
tiempo:{label:'Tiempo dedicado',options:[{v:'dia',l:'1 dÃ­a',lvl:'sofa'},{v:'semana',l:'1 semana',lvl:'mochila'},{v:'mes',l:'1 mes',lvl:'escalada'}]},
beneficio:{label:'Beneficia a',options:[{v:'grupo',l:'Grupo',lvl:'sofa'},{v:'clase',l:'Clase',lvl:'mochila'},{v:'ies',l:'Todo el IES',lvl:'escalada'}]},
esfuerzo:{label:'Esfuerzo',options:[{v:'planifica',l:'Planifica',lvl:'sofa'},{v:'prepara',l:'Prepara materiales',lvl:'mochila'},{v:'organiza',l:'Organiza',lvl:'escalada'}]},
responsabilidad:{label:'Responsabilidad',options:[{v:'sigue',l:'Sigue instrucciones',lvl:'sofa'},{v:'iniciativa',l:'Tiene iniciativa',lvl:'mochila'},{v:'ejecuta',l:'Ejecuta',lvl:'escalada'}]}
};

// TIENDA
const SHOP=[
{id:'r1',name:'Desayuno',price:200,icon:'â˜•',desc:'Desayuno gratis en cafeterÃ­a',cat:'Bienestar'},
{id:'r2',name:'Cambio de sitio',price:150,icon:'ğŸ’º',desc:'Elegir sitio en clase 1 semana',cat:'Bienestar'},
{id:'r3',name:'Entrega 1 dÃ­a tarde',price:50,icon:'ğŸ“…',desc:'Entregar tarea con 1 dÃ­a de retraso',cat:'AcadÃ©mico'},
{id:'r4',name:'Elegir grupo trabajo',price:150,icon:'ğŸ‘¥',desc:'Elegir con quiÃ©n trabajar en equipo',cat:'AcadÃ©mico'},
{id:'r5',name:'Elegir pregunta examen',price:200,icon:'â“',desc:'Elegir entre 3 preguntas en examen',cat:'AcadÃ©mico'},
{id:'r6',name:'Eliminar negativo',price:50,icon:'âŒ',desc:'Borrar un negativo (sin parte)',cat:'Conducta'},
{id:'r7',name:'Borrar/justificar falta',price:100,icon:'ğŸ“',desc:'Eliminar una falta de asistencia',cat:'Asistencia'},
{id:'r8',name:'+1 punto en RA',price:200,icon:'â­',desc:'Suma 1 punto a un Resultado de Aprendizaje',cat:'AcadÃ©mico'},
{id:'r9',name:'+0.1 sobre RA',price:25,icon:'ğŸ“Š',desc:'Suma 0.1 a un Resultado de Aprendizaje',cat:'AcadÃ©mico'},
{id:'r10',name:'15 min antes salida',price:50,icon:'ğŸšª',desc:'Salir 15 minutos antes de clase',cat:'Ocio'}
];

const initData=async()=>{
const ss=await db.ref('shop').once('value');
if(!ss.val()){const d={};SHOP.forEach(r=>{d[r.id]={...r,stock:999}});await db.ref('shop').set(d);}
};

class App{
constructor(){
this.user=null;this.users=[];this.txs=[];this.purchases=[];this.shop=[];this.customTasks=[];
this.sync='connecting';this.tab='dashboard';this.selectedGroup=null;this.modal=null;this.modalData=null;
// Para formulario variable
this.varForm={task:null,desc:'',tiempo:null,beneficio:null,esfuerzo:null,responsabilidad:null};
this.init();
}
async init(){await initData();this.listen();this.render();}
listen(){
db.ref('users').on('value',s=>{this.users=s.val()?Object.values(s.val()):[];if(this.user){const u=this.users.find(x=>x.id===this.user.id);if(u)this.user=u}this.render()});
db.ref('customTasks').on('value',s=>{this.customTasks=s.val()?Object.values(s.val()):[];this.render()});
db.ref('transactions').on('value',s=>{this.txs=s.val()?Object.values(s.val()).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)):[];this.render()});
db.ref('purchases').on('value',s=>{this.purchases=s.val()?Object.values(s.val()).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)):[];this.render()});
db.ref('shop').on('value',s=>{this.shop=s.val()?Object.values(s.val()):[];this.render()});
db.ref('.info/connected').on('value',s=>{this.sync=s.val()?'connected':'disconnected';this.render()});
}
getMyGroups(){
if(!this.user||this.user.role!=='tutor')return[];
return TUTOR_GROUPS_BY_EMAIL[this.user.email]||[];
}
getMyStudents(){
const myGroups=this.getMyGroups();
return this.users.filter(u=>u.role==='student'&&myGroups.includes(u.class));
}
getStudentsByGroup(g){
return this.users.filter(u=>u.role==='student'&&u.class===g);
}
getAllVariableTasks(){
return [...VARIABLE_TASKS,...this.customTasks];
}
async login(type,creds){
if(type==='tutor'){
const t=this.users.find(u=>u.role==='tutor'&&u.email===creds.email);
if(!t||t.password!==creds.password){alert('Credenciales incorrectas');return}
this.user=t;
const myGroups=this.getMyGroups();
this.selectedGroup=myGroups[0]||null;
}else{
const s=this.users.find(u=>u.role==='student'&&u.nick===creds.nick);
if(!s||s.password!==creds.password){alert('Credenciales incorrectas');return}
this.user=s;
}
this.tab='dashboard';this.render();
}
logout(){this.user=null;this.tab='dashboard';this.selectedGroup=null;this.render()}
setTab(t){this.tab=t;this.render()}
selectGroup(g){this.selectedGroup=g;this.render()}
openModal(t,d){this.modal=t;this.modalData=d||null;this.varForm={task:null,desc:'',tiempo:null,beneficio:null,esfuerzo:null,responsabilidad:null};this.render()}
closeModal(){this.modal=null;this.modalData=null;this.render()}

// Calcular nivel y BB segÃºn criterios
calcLevel(){
const f=this.varForm;
if(!f.tiempo||!f.beneficio||!f.esfuerzo||!f.responsabilidad)return null;
const scores={sofa:0,mochila:0,escalada:0};
[f.tiempo,f.beneficio,f.esfuerzo,f.responsabilidad].forEach(lvl=>{scores[lvl]++});
// El nivel es el que tenga mÃ¡s puntos, en empate el mÃ¡s alto
if(scores.escalada>=2)return{level:'escalada',bb:Math.round(LEVELS.escalada.min+(scores.escalada-2)*(LEVELS.escalada.max-LEVELS.escalada.min)/2)};
if(scores.mochila>=2)return{level:'mochila',bb:Math.round(LEVELS.mochila.min+(scores.mochila-2)*(LEVELS.mochila.max-LEVELS.mochila.min)/2)};
return{level:'sofa',bb:Math.round(LEVELS.sofa.min+scores.sofa*(LEVELS.sofa.max-LEVELS.sofa.min)/4)};
}
setVarField(field,value,lvl){
this.varForm[field]=lvl;
this.render();
}

// ASIGNAR TAREA FIJA
async assignFixedTask(sId,taskId){
const s=this.users.find(u=>u.id===sId);
const t=FIXED_TASKS.find(x=>x.id===taskId);
if(!s||!t)return;
const tx={id:'tx_'+Date.now(),hash:generateTxHash(),from:this.user.ethAddress,to:s.ethAddress,fromName:this.user.name,toName:s.name,toId:s.id,fromId:this.user.id,amount:t.bb,type:'fixed_task',taskIcon:t.icon,taskName:t.name,description:t.icon+' '+t.name,timestamp:new Date().toISOString(),status:'confirmed',reversed:false};
try{await db.ref('users/'+sId+'/tokens').set(s.tokens+t.bb);await db.ref('transactions/'+tx.id).set(tx);alert('âœ… '+t.bb+' '+BB+' asignados a '+s.name)}catch(e){alert('Error');console.error(e)}
}

// ASIGNAR TAREA VARIABLE
async assignVariableTask(sId){
const s=this.users.find(u=>u.id===sId);
const f=this.varForm;
const t=this.getAllVariableTasks().find(x=>x.id===f.task);
const calc=this.calcLevel();
if(!s||!t||!calc||!f.desc){alert('Completa todos los campos');return}
const lvl=LEVELS[calc.level];
const tx={id:'tx_'+Date.now(),hash:generateTxHash(),from:this.user.ethAddress,to:s.ethAddress,fromName:this.user.name,toName:s.name,toId:s.id,fromId:this.user.id,amount:calc.bb,type:'variable_task',taskIcon:t.icon,taskName:t.name,levelIcon:lvl.icon,levelName:lvl.name,description:t.icon+' '+t.name+' '+lvl.icon,detail:f.desc,criterios:{tiempo:f.tiempo,beneficio:f.beneficio,esfuerzo:f.esfuerzo,responsabilidad:f.responsabilidad},timestamp:new Date().toISOString(),status:'confirmed',reversed:false};
try{await db.ref('users/'+sId+'/tokens').set(s.tokens+calc.bb);await db.ref('transactions/'+tx.id).set(tx);alert('âœ… '+calc.bb+' '+BB+' ('+lvl.icon+' '+lvl.name+') asignados a '+s.name);this.closeModal()}catch(e){alert('Error');console.error(e)}
}

// CREAR TAREA PERSONALIZADA
async createCustomTask(name,icon){
const id='ct_'+Date.now();
const task={id,name,icon:icon||'ğŸ“Œ',type:'variable',createdBy:this.user.name,createdAt:new Date().toISOString()};
try{await db.ref('customTasks/'+id).set(task);alert('âœ… Tarea "'+name+'" creada');this.closeModal()}catch(e){alert('Error');console.error(e)}
}

// COMPRAR RECOMPENSA
async buyReward(rId,comment){
const r=this.shop.find(x=>x.id===rId);if(!r)return;
if(this.user.tokens<r.price){alert('Saldo insuficiente');return}
const p={id:'p_'+Date.now(),hash:generateTxHash(),studentId:this.user.id,studentName:this.user.name,studentClass:this.user.class,rewardId:r.id,rewardName:r.name,rewardIcon:r.icon,price:r.price,comment:comment||'',timestamp:new Date().toISOString(),status:'pending'};
const tx={id:'tx_'+Date.now(),hash:generateTxHash(),from:this.user.ethAddress,to:'0xSHOP',fromName:this.user.name,toName:'Tienda',fromId:this.user.id,toId:'shop',amount:r.price,type:'purchase',taskIcon:r.icon,description:r.icon+' '+r.name,timestamp:new Date().toISOString(),status:'confirmed'};
try{await db.ref('users/'+this.user.id+'/tokens').set(this.user.tokens-r.price);await db.ref('purchases/'+p.id).set(p);await db.ref('transactions/'+tx.id).set(tx);alert('âœ… Compra realizada');this.closeModal()}catch(e){alert('Error');console.error(e)}
}

async verifyPurchase(pId,ok){
const p=this.purchases.find(x=>x.id===pId);if(!p)return;
try{
if(ok){await db.ref('purchases/'+pId).update({status:'verified',verifiedBy:this.user.name,verifiedAt:new Date().toISOString()});alert('âœ… Verificado')}
else{const s=this.users.find(u=>u.id===p.studentId);if(s)await db.ref('users/'+p.studentId+'/tokens').set(s.tokens+p.price);await db.ref('purchases/'+pId).update({status:'rejected',verifiedBy:this.user.name});alert('âŒ Rechazado y devuelto')}
}catch(e){alert('Error');console.error(e)}
}

async revertTx(txId){
const tx=this.txs.find(t=>t.id===txId);if(!tx||tx.reversed)return;
const s=this.users.find(u=>u.id===tx.toId);if(!s||s.tokens<tx.amount){alert('No se puede revertir');return}
try{await db.ref('users/'+s.id+'/tokens').set(s.tokens-tx.amount);await db.ref('transactions/'+txId+'/reversed').set(true);alert('âœ… Revertido')}catch(e){alert('Error');console.error(e)}
}

// STATS
getStats(){
const students=this.users.filter(u=>u.role==='student');
const totalBB=students.reduce((a,s)=>a+s.tokens,0);
const txValid=this.txs.filter(tx=>!tx.reversed&&(tx.type==='fixed_task'||tx.type==='variable_task'));
const levelCounts={sofa:0,mochila:0,escalada:0};
txValid.filter(tx=>tx.levelName).forEach(tx=>{
if(tx.levelName==='SofÃ¡')levelCounts.sofa++;
else if(tx.levelName==='Mochila')levelCounts.mochila++;
else if(tx.levelName==='Escalada')levelCounts.escalada++;
});
const taskCounts={};
txValid.forEach(tx=>{const k=tx.taskIcon+' '+tx.taskName;taskCounts[k]=(taskCounts[k]||0)+1});
const topTasks=Object.entries(taskCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
const rewardCounts={};
this.purchases.filter(p=>p.status==='verified').forEach(p=>{const k=p.rewardIcon+' '+p.rewardName;rewardCounts[k]=(rewardCounts[k]||0)+1});
const topRewards=Object.entries(rewardCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
const pending=this.purchases.filter(p=>p.status==='pending');
return{totalBB,totalStudents:students.length,totalTx:txValid.length,levelCounts,topTasks,topRewards,pending};
}

render(){document.getElementById('app').innerHTML=!this.user?this.loginHTML():this.dashHTML();this.events()}

loginHTML(){
return '<div class="min-h-screen flex items-center justify-center p-4"><div class="bg-black/40 backdrop-blur-2xl rounded-3xl p-8 max-w-md w-full border border-purple-500/30 animate-glow"><div class="text-center mb-8"><div class="bg-gradient-to-br from-purple-500 to-pink-500 p-4 rounded-2xl inline-block mb-4"><span class="text-4xl">ğŸª™</span></div><h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 mb-2">'+NAME+'</h1><p class="text-purple-300 text-sm">IES Luis Braille</p><span class="inline-block mt-2 px-3 py-1 bg-purple-500/20 border border-purple-500/30 rounded-full text-xs text-purple-300">v5.0</span></div><div class="flex gap-2 mb-6"><button onclick="app.switchType(\'student\')" id="btn-s" class="flex-1 py-3 rounded-xl font-semibold bg-gradient-to-r from-purple-500 to-pink-500 text-white">Alumno</button><button onclick="app.switchType(\'tutor\')" id="btn-t" class="flex-1 py-3 rounded-xl font-semibold bg-white/5 text-gray-300">Tutor</button></div><form id="login-form" class="space-y-4"><div id="f-student"><label class="block text-sm text-gray-300 mb-2">Nick</label><input type="text" id="nick" placeholder="BRAIBIT-AD1-001" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white uppercase font-mono"><label class="block text-sm text-gray-300 mb-2 mt-4">ContraseÃ±a</label><input type="password" id="pass" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white"></div><div id="f-tutor" class="hidden"><label class="block text-sm text-gray-300 mb-2">Email</label><input type="email" id="email" placeholder="tu@iesluisbraille.edu" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white"><label class="block text-sm text-gray-300 mb-2 mt-4">ContraseÃ±a</label><input type="password" id="pass-t" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white"></div><button type="submit" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 rounded-xl font-bold">Acceder</button></form></div></div>';
}

dashHTML(){
const syncC=this.sync==='connected'?'bg-green-400 animate-pulse-slow':'bg-red-400';
const myGroups=this.getMyGroups();
const grpInfo=this.user.role==='tutor'?'<span class="text-amber-300 text-xs">'+myGroups.join(' Â· ')+'</span>':'<span class="text-gray-400 text-xs">'+this.user.class+'</span>';

const tabs=this.user.role==='tutor'?[
{id:'dashboard',l:'ğŸ“Š Dashboard'},
{id:'assign',l:'â­ Asignar'},
{id:'shop',l:'ğŸ›’ Tienda'},
{id:'history',l:'ğŸ“œ Historial'}
]:[
{id:'dashboard',l:'ğŸ“‹ Inicio'},
{id:'shop',l:'ğŸ›’ Tienda'},
{id:'ranking',l:'ğŸ† Ranking'},
{id:'history',l:'ğŸ“œ Historial'}
];
let tabsH='';tabs.forEach(t=>{tabsH+='<button onclick="app.setTab(\''+t.id+'\')" class="tab-btn flex-1 px-3 py-2 rounded-xl font-semibold text-sm '+(this.tab===t.id?'active':'text-gray-400')+'">'+t.l+'</button>'});

let content='';
switch(this.tab){
case'dashboard':content=this.user.role==='tutor'?this.dashboardPanel():this.studentPanel();break;
case'assign':content=this.assignPanel();break;
case'shop':content=this.shopPanel();break;
case'ranking':content=this.rankingPanel();break;
case'history':content=this.historyPanel();break;
}

return '<nav class="bg-black/40 backdrop-blur-xl border-b border-purple-500/20 sticky top-0 z-50"><div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between"><div class="flex items-center gap-3"><span class="text-2xl">ğŸª™</span><div><h1 class="text-lg font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">'+NAME+'</h1></div><div class="flex items-center gap-1 bg-black/30 px-2 py-1 rounded-lg ml-2"><div class="w-2 h-2 rounded-full '+syncC+'"></div></div></div><div class="flex items-center gap-3"><div class="text-right"><p class="text-white font-semibold text-sm">'+this.user.name+'</p>'+grpInfo+'</div><button onclick="app.logout()" class="px-3 py-1 bg-red-500/20 text-red-300 rounded-lg text-sm">Salir</button></div></div></nav><div class="max-w-6xl mx-auto px-4 py-4"><div class="bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-2xl p-5 border border-purple-500/30 mb-4 flex justify-between items-center"><div><p class="text-gray-400 text-xs">Balance</p><p class="text-3xl font-bold text-white font-mono">'+formatNum(this.user.tokens)+' <span class="text-purple-300 text-xl">'+BB+'</span></p></div><code class="text-purple-400 text-xs hidden sm:block">'+formatAddr(this.user.ethAddress)+'</code></div><div class="flex gap-2 mb-4 bg-black/20 p-1 rounded-xl">'+tabsH+'</div>'+content+'</div>'+(this.modal?this.modalHTML():'');
}

dashboardPanel(){
const stats=this.getStats();
const myStudents=this.getMyStudents();
const myTotalBB=myStudents.reduce((a,s)=>a+s.tokens,0);
const myGroups=this.getMyGroups();
const myPending=this.purchases.filter(p=>p.status==='pending'&&myStudents.some(s=>s.id===p.studentId));

let groupBtns='';
myGroups.forEach(g=>{
const c=GROUP_COLORS[g];
const n=this.getStudentsByGroup(g).length;
groupBtns+='<button onclick="app.selectGroup(\''+g+'\')" class="px-4 py-2 rounded-lg text-white font-bold text-sm" style="background:'+c+'">'+g+' <span class="opacity-70">('+n+')</span></button>';
});

let pendingH='';
if(myPending.length){
let items='';
myPending.forEach(p=>{
items+='<div class="bg-black/30 rounded-lg p-3 flex justify-between items-center"><div><p class="text-white">'+p.rewardIcon+' '+p.studentName+'</p><p class="text-yellow-300 text-sm">'+p.rewardName+'</p>'+(p.comment?'<p class="text-gray-400 text-xs italic">"'+p.comment+'"</p>':'')+'</div><div class="flex gap-2"><button onclick="app.verifyPurchase(\''+p.id+'\',true)" class="px-3 py-1 bg-green-500/20 text-green-300 rounded">âœ“</button><button onclick="app.verifyPurchase(\''+p.id+'\',false)" class="px-3 py-1 bg-red-500/20 text-red-300 rounded">âœ—</button></div></div>';
});
pendingH='<div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4 mb-4"><h3 class="text-yellow-300 font-bold mb-3">â³ Compras Pendientes ('+myPending.length+')</h3><div class="space-y-2">'+items+'</div></div>';
}

const total=stats.levelCounts.sofa+stats.levelCounts.mochila+stats.levelCounts.escalada||1;
const pS=(stats.levelCounts.sofa/total*100).toFixed(0);
const pM=(stats.levelCounts.mochila/total*100).toFixed(0);
const pE=(stats.levelCounts.escalada/total*100).toFixed(0);

let topT='';stats.topTasks.forEach(([k,v])=>{topT+='<div class="flex justify-between py-1"><span class="text-white text-sm">'+k+'</span><span class="text-purple-300">'+v+'</span></div>'});
let topR='';stats.topRewards.forEach(([k,v])=>{topR+='<div class="flex justify-between py-1"><span class="text-white text-sm">'+k+'</span><span class="text-emerald-300">'+v+'</span></div>'});

return pendingH+'<div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">'+
'<div class="bg-black/30 rounded-xl p-4 text-center"><p class="text-gray-400 text-xs">Mis Alumnos</p><p class="text-white text-2xl font-bold">'+myStudents.length+'</p></div>'+
'<div class="bg-black/30 rounded-xl p-4 text-center"><p class="text-gray-400 text-xs">BB Mis Grupos</p><p class="text-green-400 text-xl font-bold">'+formatNum(myTotalBB)+'</p></div>'+
'<div class="bg-black/30 rounded-xl p-4 text-center"><p class="text-gray-400 text-xs">Total IES</p><p class="text-purple-400 text-xl font-bold">'+formatNum(stats.totalBB)+'</p></div>'+
'<div class="bg-black/30 rounded-xl p-4 text-center"><p class="text-gray-400 text-xs">Transacciones</p><p class="text-amber-400 text-xl font-bold">'+stats.totalTx+'</p></div>'+
'</div><div class="flex flex-wrap gap-2 mb-4">'+groupBtns+'</div><div class="grid md:grid-cols-3 gap-4">'+
'<div class="bg-black/30 rounded-xl p-4"><h4 class="text-white font-bold mb-3">ğŸ† Top Tareas</h4>'+(topT||'<p class="text-gray-500 text-sm">Sin datos</p>')+'</div>'+
'<div class="bg-black/30 rounded-xl p-4"><h4 class="text-white font-bold mb-3">ğŸšï¸ Niveles</h4><div class="space-y-2"><div><div class="flex justify-between text-sm"><span class="text-green-400">ğŸ›‹ï¸ SofÃ¡</span><span>'+pS+'%</span></div><div class="h-2 bg-black/50 rounded-full mt-1"><div class="h-2 bg-green-500 rounded-full" style="width:'+pS+'%"></div></div></div><div><div class="flex justify-between text-sm"><span class="text-amber-400">ğŸ’ Mochila</span><span>'+pM+'%</span></div><div class="h-2 bg-black/50 rounded-full mt-1"><div class="h-2 bg-amber-500 rounded-full" style="width:'+pM+'%"></div></div></div><div><div class="flex justify-between text-sm"><span class="text-red-400">ğŸ§— Escalada</span><span>'+pE+'%</span></div><div class="h-2 bg-black/50 rounded-full mt-1"><div class="h-2 bg-red-500 rounded-full" style="width:'+pE+'%"></div></div></div></div></div>'+
'<div class="bg-black/30 rounded-xl p-4"><h4 class="text-white font-bold mb-3">ğŸ›’ Top Recompensas</h4>'+(topR||'<p class="text-gray-500 text-sm">Sin datos</p>')+'</div></div>';
}

assignPanel(){
const myGroups=this.getMyGroups();
if(!this.selectedGroup)this.selectedGroup=myGroups[0];
const students=this.getStudentsByGroup(this.selectedGroup).sort((a,b)=>a.name.localeCompare(b.name));

let groupBtns='';
myGroups.forEach(g=>{
const c=GROUP_COLORS[g];
const active=this.selectedGroup===g;
groupBtns+='<button onclick="app.selectGroup(\''+g+'\')" class="px-4 py-2 rounded-lg font-bold text-sm '+(active?'text-white':'text-gray-300 opacity-60')+'" style="background:'+(active?c:c+'40')+'">'+g+'</button>';
});

let sOpts='<option value="">-- Alumno --</option>';
students.forEach(s=>{sOpts+='<option value="'+s.id+'">'+s.name+' ('+formatNum(s.tokens)+' BB)</option>'});

// TAREAS FIJAS
let fixedH='';
FIXED_TASKS.forEach(t=>{
fixedH+='<div class="bg-white/5 rounded-lg p-3 flex justify-between items-center card-hover"><div class="flex items-center gap-2"><span class="text-2xl">'+t.icon+'</span><span class="text-white">'+t.name+'</span></div><span class="text-green-400 font-mono font-bold">'+t.bb+' BB</span></div>';
});

// TAREAS VARIABLES
let varH='';
this.getAllVariableTasks().forEach(t=>{
varH+='<div class="bg-white/5 rounded-lg p-3 flex justify-between items-center card-hover"><div class="flex items-center gap-2"><span class="text-2xl">'+t.icon+'</span><span class="text-white">'+t.name+'</span></div><span class="text-amber-400 text-xs">ğŸ›‹ï¸ğŸ’ğŸ§—</span></div>';
});

return '<div class="flex flex-wrap gap-2 mb-4">'+groupBtns+'</div>'+
'<div class="grid lg:grid-cols-2 gap-4">'+
// TAREAS FIJAS
'<div class="bg-gradient-to-br from-green-500/10 to-emerald-500/10 rounded-xl p-5 border border-green-500/30">'+
'<h3 class="text-white font-bold text-lg mb-3">ğŸ“‹ Tareas Fijas</h3>'+
'<p class="text-gray-400 text-sm mb-3">Valor fijo, asignaciÃ³n directa</p>'+
'<div class="space-y-2 mb-4">'+fixedH+'</div>'+
'<div class="bg-black/30 rounded-lg p-4"><label class="text-gray-300 text-sm">Alumno</label><select id="sel-s-fixed" class="w-full mt-1 px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white">'+sOpts+'</select><label class="text-gray-300 text-sm mt-3 block">Tarea</label><select id="sel-t-fixed" class="w-full mt-1 px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white"><option value="">-- Tarea --</option>'+FIXED_TASKS.map(t=>'<option value="'+t.id+'">'+t.icon+' '+t.name+' ('+t.bb+' BB)</option>').join('')+'</select><button onclick="app.doAssignFixed()" class="w-full mt-4 py-3 rounded-lg bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold">âš¡ Asignar</button></div>'+
'</div>'+
// TAREAS VARIABLES
'<div class="bg-gradient-to-br from-amber-500/10 to-orange-500/10 rounded-xl p-5 border border-amber-500/30">'+
'<h3 class="text-white font-bold text-lg mb-3">ğŸšï¸ Tareas Variables</h3>'+
'<p class="text-gray-400 text-sm mb-3">BB segÃºn nivel de implicaciÃ³n</p>'+
'<div class="space-y-2 mb-4">'+varH+'</div>'+
'<button onclick="app.openModal(\'assignVar\')" class="w-full py-3 rounded-lg bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold">ğŸ“ Asignar con Formulario</button>'+
'<button onclick="app.openModal(\'newTask\')" class="w-full mt-2 py-2 rounded-lg bg-white/10 text-gray-300 text-sm">+ Crear nueva tarea</button>'+
'</div>'+
'</div>';
}

shopPanel(){
const cats=[...new Set(this.shop.map(i=>i.cat))];
const bal=this.user.role==='student'?'<span class="text-white font-mono font-bold">'+formatNum(this.user.tokens)+' '+BB+'</span>':'';

let catsH='';
cats.forEach(cat=>{
const items=this.shop.filter(i=>i.cat===cat);
let itemsH='';
items.forEach(item=>{
let btn='';
if(this.user.role==='student'){
const can=this.user.tokens>=item.price;
btn=can?'<button onclick="app.openModal(\'buy\',\''+item.id+'\')" class="px-3 py-1 bg-emerald-500/20 text-emerald-300 rounded text-sm">Comprar</button>':'<span class="text-gray-500 text-xs">Sin saldo</span>';
}
itemsH+='<div class="bg-black/30 rounded-lg p-3 card-hover"><div class="flex items-start gap-3"><span class="text-2xl">'+item.icon+'</span><div class="flex-1"><p class="text-white font-semibold">'+item.name+'</p><p class="text-gray-400 text-xs">'+item.desc+'</p><div class="flex justify-between items-center mt-2"><span class="text-emerald-300 font-mono">'+item.price+' BB</span>'+btn+'</div></div></div></div>';
});
catsH+='<div class="mb-4"><h4 class="text-emerald-300 font-semibold mb-2">'+cat+'</h4><div class="grid sm:grid-cols-2 gap-3">'+itemsH+'</div></div>';
});

let myP='';
if(this.user.role==='student'){
const mp=this.purchases.filter(p=>p.studentId===this.user.id);
if(mp.length){
let items='';
mp.slice(0,5).forEach(p=>{
const st=p.status==='verified'?'âœ“ OK':p.status==='pending'?'â³':'âœ—';
const stC=p.status==='verified'?'text-green-300':p.status==='pending'?'text-yellow-300':'text-red-300';
items+='<div class="flex justify-between py-2 border-b border-white/5"><span class="text-white">'+p.rewardIcon+' '+p.rewardName+'</span><span class="'+stC+' text-sm">'+st+'</span></div>';
});
myP='<div class="bg-black/30 rounded-xl p-4 mt-4"><h4 class="text-white font-bold mb-2">ğŸ§¾ Mis Compras</h4>'+items+'</div>';
}
}

return '<div class="bg-gradient-to-br from-emerald-500/10 to-teal-500/10 rounded-xl p-5 border border-emerald-500/30"><div class="flex justify-between items-center mb-4"><h3 class="text-white font-bold text-xl">ğŸ›’ Tienda</h3>'+bal+'</div>'+catsH+'</div>'+myP;
}

studentPanel(){
let fixedH='';
FIXED_TASKS.forEach(t=>{fixedH+='<div class="flex justify-between py-2 border-b border-white/5"><span class="text-white">'+t.icon+' '+t.name+'</span><span class="text-green-400 font-mono">'+t.bb+' BB</span></div>'});
let varH='';
VARIABLE_TASKS.forEach(t=>{varH+='<div class="flex justify-between py-2 border-b border-white/5"><span class="text-white">'+t.icon+' '+t.name+'</span><span class="text-amber-400 text-sm">25-200 BB</span></div>'});

return '<div class="grid md:grid-cols-2 gap-4">'+
'<div class="bg-black/30 rounded-xl p-5"><h3 class="text-white font-bold mb-3">ğŸ“‹ Tareas Fijas</h3>'+fixedH+'</div>'+
'<div class="bg-black/30 rounded-xl p-5"><h3 class="text-white font-bold mb-3">ğŸšï¸ Tareas Variables</h3>'+varH+'<div class="mt-4 p-3 bg-amber-500/10 rounded-lg text-sm"><p class="text-amber-300 font-bold mb-1">Niveles:</p><p class="text-gray-300">ğŸ›‹ï¸ SofÃ¡: 25-50 BB</p><p class="text-gray-300">ğŸ’ Mochila: 75-120 BB</p><p class="text-gray-300">ğŸ§— Escalada: 150-200 BB</p></div></div>'+
'</div>';
}

rankingPanel(){
const ss=this.users.filter(u=>u.role==='student').sort((a,b)=>b.tokens-a.tokens);
const pos=ss.findIndex(s=>s.id===this.user.id)+1;
let rows='';
ss.slice(0,30).forEach((s,i)=>{
const m=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'#'+(i+1);
const me=s.id===this.user.id;
const c=GROUP_COLORS[s.class];
rows+='<div class="flex justify-between items-center py-2 '+(me?'bg-purple-500/20 rounded-lg px-2':'')+'"><div class="flex items-center gap-2"><span class="w-8 text-center">'+m+'</span><span class="text-white">'+s.name+(me?' (TÃº)':'')+'</span><span class="text-xs px-2 py-0.5 rounded" style="background:'+c+'30;color:'+c+'">'+s.class+'</span></div><span class="text-white font-mono">'+formatNum(s.tokens)+'</span></div>';
});
return '<div class="bg-gradient-to-r from-amber-500/20 to-orange-500/20 rounded-xl p-5 border border-amber-500/30 mb-4"><div class="flex justify-between"><div><p class="text-amber-300 text-sm">Tu posiciÃ³n</p><p class="text-white text-3xl font-bold">#'+pos+'</p></div><div class="text-right"><p class="text-amber-300 text-sm">Tu saldo</p><p class="text-white text-2xl font-mono">'+formatNum(this.user.tokens)+' BB</p></div></div></div><div class="bg-black/30 rounded-xl p-5"><h3 class="text-white font-bold mb-3">ğŸ† Ranking</h3><div class="space-y-1">'+rows+'</div></div>';
}

historyPanel(){
const myStudents=this.getMyStudents();
let txs=this.user.role==='tutor'?this.txs.filter(tx=>myStudents.some(s=>s.id===tx.toId)):this.txs.filter(tx=>tx.toId===this.user.id||tx.fromId===this.user.id);
let items='';
txs.slice(0,30).forEach(tx=>{
const rev=tx.reversed?'opacity-50 line-through':'';
const revBadge=tx.reversed?'<span class="text-red-400 text-xs ml-1">(anulada)</span>':'';
const revBtn=this.user.role==='tutor'&&!tx.reversed&&tx.type!=='purchase'?'<button onclick="app.revertTx(\''+tx.id+'\')" class="text-red-400 text-xs">â†©ï¸</button>':'';
const lvl=tx.levelIcon?'<span class="text-xs">'+tx.levelIcon+'</span>':'';
items+='<div class="flex justify-between items-center py-2 border-b border-white/5 '+rev+'"><div><p class="text-white">'+tx.taskIcon+' '+tx.taskName+' '+lvl+revBadge+'</p><p class="text-gray-400 text-xs">'+tx.toName+' Â· '+formatDate(tx.timestamp)+'</p>'+(tx.detail?'<p class="text-gray-500 text-xs italic">"'+tx.detail+'"</p>':'')+'</div><div class="text-right flex items-center gap-2"><span class="text-green-400 font-mono">+'+formatNum(tx.amount)+'</span>'+revBtn+'</div></div>';
});
return '<div class="bg-black/30 rounded-xl p-5"><div class="flex justify-between mb-3"><h3 class="text-white font-bold">ğŸ“œ Historial</h3><span class="text-gray-400 text-sm">'+txs.length+' tx</span></div>'+(items||'<p class="text-gray-500">Sin transacciones</p>')+'</div>';
}

modalHTML(){
let c='';
if(this.modal==='buy'){
const r=this.shop.find(x=>x.id===this.modalData);
if(r)c='<h3 class="text-white font-bold text-xl mb-2">'+r.icon+' '+r.name+'</h3><p class="text-emerald-300 font-mono text-2xl mb-4">'+r.price+' BB</p><label class="text-gray-300 text-sm">Â¿QuÃ© quieres conseguir? (opcional)</label><textarea id="buy-comment" rows="2" class="w-full mt-1 px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white" placeholder="Explica brevemente..."></textarea><div class="flex gap-3 mt-4"><button onclick="app.closeModal()" class="flex-1 py-2 bg-white/10 text-gray-300 rounded-lg">Cancelar</button><button onclick="app.doBuy(\''+r.id+'\')" class="flex-1 py-2 bg-emerald-500 text-white rounded-lg font-bold">Comprar</button></div>';
}
else if(this.modal==='newTask'){
c='<h3 class="text-white font-bold text-xl mb-4">â• Nueva Tarea Variable</h3><label class="text-gray-300 text-sm">Nombre</label><input type="text" id="new-name" class="w-full mt-1 px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white" placeholder="Ej: Proyecto solidario"><label class="text-gray-300 text-sm mt-3 block">Icono</label><input type="text" id="new-icon" class="w-full mt-1 px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white text-2xl" placeholder="ğŸ“Œ" maxlength="2"><div class="flex gap-3 mt-4"><button onclick="app.closeModal()" class="flex-1 py-2 bg-white/10 text-gray-300 rounded-lg">Cancelar</button><button onclick="app.doCreateTask()" class="flex-1 py-2 bg-purple-500 text-white rounded-lg font-bold">Crear</button></div>';
}
else if(this.modal==='assignVar'){
const students=this.getStudentsByGroup(this.selectedGroup).sort((a,b)=>a.name.localeCompare(b.name));
let sOpts='<option value="">-- Alumno --</option>';students.forEach(s=>{sOpts+='<option value="'+s.id+'">'+s.name+'</option>'});
let tOpts='<option value="">-- Tarea --</option>';this.getAllVariableTasks().forEach(t=>{tOpts+='<option value="'+t.id+'">'+t.icon+' '+t.name+'</option>'});

const calc=this.calcLevel();
let resultH='';
if(calc){
const lvl=LEVELS[calc.level];
resultH='<div class="p-3 rounded-lg text-center" style="background:'+lvl.color+'30"><span class="text-3xl">'+lvl.icon+'</span><p class="text-white font-bold text-lg">'+lvl.name+'</p><p class="text-white text-2xl font-mono">'+calc.bb+' BB</p></div>';
}else{
resultH='<div class="p-3 bg-white/5 rounded-lg text-center text-gray-400">Completa los criterios</div>';
}

// Criterios
let criteriosH='';
Object.entries(CRITERIA).forEach(([key,crit])=>{
let optsH='';
crit.options.forEach(opt=>{
const active=this.varForm[key]===opt.lvl;
const lvlC=LEVELS[opt.lvl].color;
optsH+='<button onclick="app.setVarField(\''+key+'\',\''+opt.v+'\',\''+opt.lvl+'\')" class="opt-btn px-3 py-2 rounded-lg text-white text-sm '+(active?'active':'')+'" style="background:'+lvlC+'">'+opt.l+'</button>';
});
criteriosH+='<div class="mb-3"><label class="text-gray-300 text-sm block mb-1">'+crit.label+'</label><div class="flex gap-2 flex-wrap">'+optsH+'</div></div>';
});

c='<h3 class="text-white font-bold text-xl mb-4">ğŸ“ Asignar Tarea Variable</h3><div class="grid md:grid-cols-2 gap-4"><div><label class="text-gray-300 text-sm">Alumno ('+this.selectedGroup+')</label><select id="var-student" class="w-full mt-1 px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white">'+sOpts+'</select><label class="text-gray-300 text-sm mt-3 block">Tarea</label><select id="var-task" onchange="app.varForm.task=this.value;app.render()" class="w-full mt-1 px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white">'+tOpts+'</select><label class="text-gray-300 text-sm mt-3 block">DescripciÃ³n de la actividad</label><textarea id="var-desc" rows="2" class="w-full mt-1 px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white" placeholder="Â¿QuÃ© hizo exactamente el alumno?">'+this.varForm.desc+'</textarea></div><div><p class="text-white font-bold mb-2">Criterios</p>'+criteriosH+resultH+'</div></div><div class="flex gap-3 mt-4"><button onclick="app.closeModal()" class="flex-1 py-2 bg-white/10 text-gray-300 rounded-lg">Cancelar</button><button onclick="app.doAssignVar()" class="flex-1 py-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-lg font-bold"'+(calc?'':' disabled')+'>Asignar '+(calc?calc.bb+' BB':'')+'</button></div>';
}
return '<div class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4" onclick="if(event.target===this)app.closeModal()"><div class="bg-slate-900 rounded-2xl p-6 max-w-2xl w-full border border-purple-500/30 max-h-[90vh] overflow-y-auto">'+c+'</div></div>';
}

events(){
const f=document.getElementById('login-form');
if(f)f.onsubmit=e=>{e.preventDefault();const isS=document.getElementById('btn-s').classList.contains('bg-gradient-to-r');if(isS)this.login('student',{nick:document.getElementById('nick').value.toUpperCase(),password:document.getElementById('pass').value});else this.login('tutor',{email:document.getElementById('email').value,password:document.getElementById('pass-t').value})};
}

switchType(type){
const bs=document.getElementById('btn-s'),bt=document.getElementById('btn-t'),fs=document.getElementById('f-student'),ft=document.getElementById('f-tutor');
if(type==='student'){bs.className='flex-1 py-3 rounded-xl font-semibold bg-gradient-to-r from-purple-500 to-pink-500 text-white';bt.className='flex-1 py-3 rounded-xl font-semibold bg-white/5 text-gray-300';fs.classList.remove('hidden');ft.classList.add('hidden')}
else{bt.className='flex-1 py-3 rounded-xl font-semibold bg-gradient-to-r from-purple-500 to-pink-500 text-white';bs.className='flex-1 py-3 rounded-xl font-semibold bg-white/5 text-gray-300';ft.classList.remove('hidden');fs.classList.add('hidden')}
}

doAssignFixed(){
const sId=document.getElementById('sel-s-fixed').value;
const tId=document.getElementById('sel-t-fixed').value;
if(!sId||!tId){alert('Selecciona alumno y tarea');return}
this.assignFixedTask(sId,tId);
}

doAssignVar(){
const sId=document.getElementById('var-student').value;
this.varForm.task=document.getElementById('var-task').value;
this.varForm.desc=document.getElementById('var-desc').value;
if(!sId){alert('Selecciona alumno');return}
this.assignVariableTask(sId);
}

doBuy(rId){
const comment=document.getElementById('buy-comment')?.value||'';
this.buyReward(rId,comment);
}

doCreateTask(){
const name=document.getElementById('new-name').value;
const icon=document.getElementById('new-icon').value;
if(!name){alert('Escribe un nombre');return}
this.createCustomTask(name,icon);
}
}

const app=new App();
</script>
</body>
</html>
