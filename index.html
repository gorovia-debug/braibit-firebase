<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BraiBit v3.0 - IES Luis Braille</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-slow{0%,100%{opacity:1}50%{opacity:.5}}.animate-pulse-slow{animation:pulse-slow 3s ease infinite}
        @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}.animate-float{animation:float 4s ease-in-out infinite}
        @keyframes glow{0%,100%{box-shadow:0 0 20px rgba(147,51,234,.3)}50%{box-shadow:0 0 40px rgba(147,51,234,.6)}}.animate-glow{animation:glow 2s ease infinite}
        ::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:rgba(0,0,0,.1)}::-webkit-scrollbar-thumb{background:rgba(147,51,234,.5);border-radius:4px}
        .tab-btn{transition:all .3s}.tab-btn.active{background:linear-gradient(135deg,#9333ea,#ec4899);color:#fff}
        .modal-backdrop{background:rgba(0,0,0,.8);backdrop-filter:blur(8px)}
        .card-hover:hover{transform:translateY(-4px);box-shadow:0 20px 40px rgba(147,51,234,.2)}
        select{background-color:rgba(255,255,255,0.1);color:white}
        select option{background-color:#ffffff;color:#000000;padding:10px}
        .group-btn{transition:all .2s}
        .group-btn.active{transform:scale(1.05)}
    </style>
</head>
<body class="bg-gradient-to-br from-slate-950 via-purple-950 to-slate-950 min-h-screen">
<div id="app"></div>
<script>
const firebaseConfig={apiKey:"AIzaSyCikAEptyqDRjUSdSgd7o6mxaFvfK91u-Y",authDomain:"moneda-social-4692b.firebaseapp.com",databaseURL:"https://moneda-social-4692b-default-rtdb.europe-west1.firebasedatabase.app",projectId:"moneda-social-4692b",storageBucket:"moneda-social-4692b.firebasestorage.app",messagingSenderId:"893005212499",appId:"1:893005212499:web:93cd8280422e43acb50fa6"};
if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const generateEthAddress=()=>{let a='0x';for(let i=0;i<40;i++)a+='0123456789abcdef'[Math.floor(Math.random()*16)];return a};
const generateTxHash=()=>{let h='0x';for(let i=0;i<64;i++)h+='0123456789abcdef'[Math.floor(Math.random()*16)];return h};
const calculateGasFee=a=>Math.max(0.1,a*0.001);
const formatAddr=a=>a?a.slice(0,6)+'...'+a.slice(-4):'';
const formatNum=n=>new Intl.NumberFormat('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2}).format(n);
const formatDate=d=>new Date(d).toLocaleString('es-ES',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});
const BB='BB',NAME='BraiBit',RATIO=100;

// ASIGNACION CORRECTA - por email para identificar
const TUTOR_GROUPS_BY_EMAIL={
'margarita@iesluisbraille.edu':['AD-1','AD-2'],
'miriam@iesluisbraille.edu':['CI-2'],
'ana@iesluisbraille.edu':['DAW-1'],
'elkin@iesluisbraille.edu':['DAW-1'],
'gonzalo@iesluisbraille.edu':['AC-1','AC-2'],
'rocio@iesluisbraille.edu':['AC-1','AC-2']
};

const GROUP_COLORS={
'AD-1':'#fbbf24',
'AD-2':'#60a5fa',
'DAW-1':'#34d399',
'AC-1':'#f472b6',
'AC-2':'#a78bfa',
'CI-2':'#fb923c'
};

const SHOP=[
{id:'r1',name:'Entregar tarea 1 dia tarde',price:200,desc:'Permiso para entregar con 1 dia de retraso',cat:'Academico',stock:999},
{id:'r2',name:'Pregunta extra en examen',price:300,desc:'Una pregunta adicional para subir nota',cat:'Academico',stock:999},
{id:'r3',name:'Elegir tema de trabajo',price:150,desc:'Derecho a elegir el tema de un trabajo',cat:'Academico',stock:999},
{id:'r4',name:'Desayuno gratis cafeteria',price:100,desc:'Un desayuno gratuito en la cafeteria',cat:'Bienestar',stock:50},
{id:'r5',name:'15 min juegos en clase',price:250,desc:'15 minutos de tiempo libre',cat:'Ocio',stock:999},
{id:'r6',name:'Uso movil 10 min',price:75,desc:'Permiso para usar el movil 10 min',cat:'Ocio',stock:999},
{id:'r7',name:'Cambio de sitio 1 semana',price:125,desc:'Elegir tu sitio en clase durante una semana',cat:'Bienestar',stock:999},
{id:'r8',name:'Libro sorpresa biblioteca',price:400,desc:'Un libro sorpresa de la biblioteca',cat:'Cultura',stock:20},
{id:'r9',name:'Diploma BraiBit Oro',price:500,desc:'Diploma oficial nivel Oro',cat:'Reconocimiento',stock:999},
{id:'r10',name:'+0.25 nota final',price:1000,desc:'Bonificacion de 0.25 en nota final',cat:'Academico',stock:10}
];

const initData=async()=>{
const ss=await db.ref('shop').once('value');
if(!ss.val()){const d={};SHOP.forEach(r=>{d[r.id]=r});await db.ref('shop').set(d);}
};

class App{
constructor(){
this.user=null;this.users=[];this.tasks=[];this.groups=[];this.txs=[];this.purchases=[];this.shop=[];
this.sync='connecting';this.tab='dashboard';this.selectedGroup=null;this.modal=null;this.modalData=null;
this.init();
}
async init(){await initData();this.listen();this.render();}
listen(){
db.ref('users').on('value',s=>{this.users=s.val()?Object.values(s.val()):[];if(this.user){const u=this.users.find(x=>x.id===this.user.id);if(u)this.user=u}this.render()});
db.ref('tasks').on('value',s=>{this.tasks=s.val()?Object.values(s.val()):[];this.render()});
db.ref('groups').on('value',s=>{this.groups=s.val()?Object.values(s.val()):[];this.render()});
db.ref('transactions').on('value',s=>{this.txs=s.val()?Object.values(s.val()).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)):[];this.render()});
db.ref('purchases').on('value',s=>{this.purchases=s.val()?Object.values(s.val()).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)):[];this.render()});
db.ref('shop').on('value',s=>{this.shop=s.val()?Object.values(s.val()):[];this.render()});
db.ref('.info/connected').on('value',s=>{this.sync=s.val()?'connected':'disconnected';this.render()});
}
// Obtener grupos del tutor por su email
getMyGroups(){
if(!this.user||this.user.role!=='tutor')return[];
return TUTOR_GROUPS_BY_EMAIL[this.user.email]||[];
}
getMyStudents(){
const myGroups=this.getMyGroups();
return this.users.filter(u=>u.role==='student'&&myGroups.includes(u.class));
}
getStudentsByGroup(groupName){
return this.users.filter(u=>u.role==='student'&&u.class===groupName);
}
async login(type,creds){
if(type==='tutor'){
const t=this.users.find(u=>u.role==='tutor'&&u.email===creds.email);
if(!t||t.password!==creds.password){alert('Credenciales incorrectas');return}
this.user=t;
// Seleccionar primer grupo por defecto
const myGroups=TUTOR_GROUPS_BY_EMAIL[t.email]||[];
this.selectedGroup=myGroups[0]||null;
}else{
const s=this.users.find(u=>u.role==='student'&&u.nick===creds.nick);
if(!s||s.password!==creds.password){alert('Credenciales incorrectas');return}
this.user=s;
}
this.tab='dashboard';this.render();
}
logout(){this.user=null;this.tab='dashboard';this.selectedGroup=null;this.render()}
setTab(t){this.tab=t;this.render()}
selectGroup(g){this.selectedGroup=g;this.render()}
openModal(t,d){this.modal=t;this.modalData=d||null;this.render()}
closeModal(){this.modal=null;this.modalData=null;this.render()}
grade(t){return(t*0.1/RATIO).toFixed(2)}

async assignTask(sId,tId){
const s=this.users.find(u=>u.id===sId),t=this.tasks.find(x=>x.id===tId);if(!s||!t)return;
const gas=calculateGasFee(t.reward),net=t.reward-gas;
const tx={id:'tx_'+Date.now(),hash:generateTxHash(),from:this.user.ethAddress,to:s.ethAddress,fromName:this.user.name,toName:s.name,toId:s.id,fromId:this.user.id,amount:t.reward,netAmount:net,gasFee:gas,type:'task_reward',description:t.name,timestamp:new Date().toISOString(),status:'confirmed',confirmations:3,reversed:false};
try{await db.ref('users/'+sId+'/tokens').set(s.tokens+net);await db.ref('transactions/'+tx.id).set(tx);alert('OK! '+t.reward+' '+BB+' asignados a '+s.name)}catch(e){alert('Error');console.error(e)}
}
async transferP2P(toId,amt,msg){
const to=this.users.find(u=>u.id===toId);if(!to){alert('No encontrado');return}
if(toId===this.user.id){alert('No puedes enviarte a ti mismo');return}
const gas=calculateGasFee(amt),total=amt+gas;
if(this.user.tokens<total){alert('Saldo insuficiente');return}
const tx={id:'tx_'+Date.now(),hash:generateTxHash(),from:this.user.ethAddress,to:to.ethAddress,fromName:this.user.name,toName:to.name,toId:to.id,fromId:this.user.id,amount:amt,netAmount:amt,gasFee:gas,type:'p2p_transfer',description:msg||'Transferencia P2P',timestamp:new Date().toISOString(),status:'confirmed',confirmations:3};
try{await db.ref('users/'+this.user.id+'/tokens').set(this.user.tokens-total);await db.ref('users/'+toId+'/tokens').set(to.tokens+amt);await db.ref('transactions/'+tx.id).set(tx);alert(formatNum(amt)+' '+BB+' enviados');this.closeModal()}catch(e){alert('Error');console.error(e)}
}
async buyReward(rId){
const r=this.shop.find(x=>x.id===rId);if(!r){alert('No encontrado');return}
if(this.user.tokens<r.price){alert('Saldo insuficiente');return}
if(r.stock<=0){alert('Agotado');return}
const p={id:'p_'+Date.now(),hash:generateTxHash(),studentId:this.user.id,studentName:this.user.name,studentClass:this.user.class,rewardId:r.id,rewardName:r.name,price:r.price,timestamp:new Date().toISOString(),status:'pending'};
const tx={id:'tx_'+Date.now(),hash:generateTxHash(),from:this.user.ethAddress,to:'0x0000000000000000000000000000000000000000',fromName:this.user.name,toName:'BraiBit Shop',fromId:this.user.id,toId:'shop',amount:r.price,netAmount:r.price,gasFee:0,type:'shop_purchase',description:'Compra: '+r.name,timestamp:new Date().toISOString(),status:'confirmed',confirmations:3};
try{await db.ref('users/'+this.user.id+'/tokens').set(this.user.tokens-r.price);await db.ref('shop/'+rId+'/stock').set(r.stock-1);await db.ref('purchases/'+p.id).set(p);await db.ref('transactions/'+tx.id).set(tx);alert('Comprado! Un tutor lo verificara.')}catch(e){alert('Error');console.error(e)}
}
async verifyPurchase(pId,ok){
const p=this.purchases.find(x=>x.id===pId);if(!p)return;
try{
if(ok){await db.ref('purchases/'+pId).update({status:'verified',verifiedBy:this.user.name,verifiedAt:new Date().toISOString()});alert('Verificado')}
else{const s=this.users.find(u=>u.id===p.studentId);if(s){await db.ref('users/'+p.studentId+'/tokens').set(s.tokens+p.price);const r=this.shop.find(x=>x.id===p.rewardId);if(r)await db.ref('shop/'+p.rewardId+'/stock').set(r.stock+1)}await db.ref('purchases/'+pId).update({status:'rejected',verifiedBy:this.user.name});alert('Rechazado y devuelto')}
}catch(e){alert('Error');console.error(e)}
}
async revertTx(txId){
const tx=this.txs.find(t=>t.id===txId);if(!tx||tx.reversed||tx.type==='reversal'){alert('No se puede revertir');return}
const s=this.users.find(u=>u.id===tx.toId);if(!s){alert('Alumno no encontrado');return}
if(s.tokens<tx.netAmount){alert('El alumno no tiene suficiente saldo ('+formatNum(s.tokens)+' '+BB+')');return}
const rev={id:'tx_'+Date.now(),hash:generateTxHash(),from:s.ethAddress,to:this.user.ethAddress,fromName:s.name,toName:this.user.name,fromId:s.id,toId:this.user.id,amount:tx.netAmount,netAmount:tx.netAmount,gasFee:0,type:'reversal',description:'REVERSION: '+tx.description,originalTxId:tx.id,timestamp:new Date().toISOString(),status:'confirmed',confirmations:3};
try{await db.ref('users/'+s.id+'/tokens').set(s.tokens-tx.netAmount);await db.ref('transactions/'+tx.id+'/reversed').set(true);await db.ref('transactions/'+rev.id).set(rev);alert('Revertida correctamente');this.closeModal()}catch(e){alert('Error');console.error(e)}
}

render(){
const el=document.getElementById('app');
el.innerHTML=!this.user?this.loginHTML():this.dashHTML();
this.events();
}
loginHTML(){
return '<div class="min-h-screen flex items-center justify-center p-4"><div class="bg-black/40 backdrop-blur-2xl rounded-3xl p-8 max-w-md w-full border border-purple-500/30 animate-glow"><div class="text-center mb-8"><div class="bg-gradient-to-br from-purple-500 to-pink-500 p-4 rounded-2xl inline-block mb-4 animate-float"><svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div><h1 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 mb-2">'+NAME+'</h1><p class="text-purple-300 text-sm">IES Luis Braille</p><span class="inline-block mt-2 px-3 py-1 bg-purple-500/20 border border-purple-500/30 rounded-full text-xs text-purple-300">v3.1</span></div><div class="flex gap-2 mb-6"><button onclick="app.switchType(\'student\')" id="btn-s" class="flex-1 py-3 rounded-xl font-semibold bg-gradient-to-r from-purple-500 to-pink-500 text-white">Alumno</button><button onclick="app.switchType(\'tutor\')" id="btn-t" class="flex-1 py-3 rounded-xl font-semibold bg-white/5 text-gray-300">Tutor</button></div><form id="login-form" class="space-y-4"><div id="f-student"><label class="block text-sm text-gray-300 mb-2">Nick</label><input type="text" id="nick" placeholder="BRAIBIT-AD1-001" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white uppercase font-mono"><label class="block text-sm text-gray-300 mb-2 mt-4">Contrasena</label><input type="password" id="pass" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white"></div><div id="f-tutor" class="hidden"><label class="block text-sm text-gray-300 mb-2">Email</label><input type="email" id="email" placeholder="tu@iesluisbraille.edu" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white"><label class="block text-sm text-gray-300 mb-2 mt-4">Contrasena</label><input type="password" id="pass-t" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white"></div><button type="submit" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 rounded-xl font-bold">Acceder</button></form></div></div>';
}

dashHTML(){
const syncC=this.sync==='connected'?'bg-green-400 animate-pulse-slow':'bg-red-400';
const syncT=this.sync==='connected'?'Sync':'Offline';
const role=this.user.role==='tutor'?'Tutor':'Alumno';
const myGroups=this.getMyGroups();
const grpInfo=this.user.role==='tutor'?'<p class="text-xs text-amber-300 font-semibold">'+myGroups.join(' | ')+'</p>':'<p class="text-xs text-gray-400">'+this.user.class+'</p>';
const grade=this.grade(this.user.tokens);
const gradeS=this.user.role==='student'?'<div class="flex items-center gap-2 mt-2"><span class="text-gray-400 text-sm">Equivalencia:</span><span class="bg-green-500/20 text-green-300 px-3 py-1 rounded-full text-sm">+'+grade+' pts</span></div>':'';
const sendBtn=this.user.role==='student'?'<button onclick="app.openModal(\'transfer\')" class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white px-6 py-3 rounded-xl font-bold">Enviar '+BB+'</button>':'';

const tabs=this.user.role==='tutor'?[
{id:'dashboard',l:'üìä Mis Alumnos'},
{id:'assign',l:'‚≠ê Asignar'},
{id:'shop',l:'üõí Tienda'},
{id:'grades',l:'üìã Notas'},
{id:'history',l:'üìú Historial'}
]:[
{id:'dashboard',l:'üìã Tareas'},
{id:'shop',l:'üõí Tienda'},
{id:'ranking',l:'üèÜ Ranking'},
{id:'history',l:'üìú Historial'}
];
let tabsH='';tabs.forEach(t=>{tabsH+='<button onclick="app.setTab(\''+t.id+'\')" class="tab-btn flex-1 px-4 py-3 rounded-xl font-semibold text-sm '+(this.tab===t.id?'active':'text-gray-400')+'">'+t.l+'</button>'});

let content='';
switch(this.tab){
case'dashboard':content=this.user.role==='tutor'?this.myStudentsPanel():this.studentPanel();break;
case'assign':content=this.assignPanel();break;
case'shop':content=this.shopPanel();break;
case'grades':content=this.gradesPanel();break;
case'ranking':content=this.rankingPanel();break;
case'history':content=this.historyPanel();break;
}

return '<nav class="bg-black/40 backdrop-blur-xl border-b border-purple-500/20 sticky top-0 z-50"><div class="max-w-7xl mx-auto px-4 py-3"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><div class="bg-gradient-to-br from-purple-500 to-pink-500 p-2 rounded-xl"><svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div><div><h1 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">'+NAME+'</h1><p class="text-xs text-purple-300">IES Luis Braille</p></div><div class="ml-4 flex items-center gap-2 bg-purple-500/10 border border-purple-500/30 px-4 py-2 rounded-lg"><div class="w-2 h-2 rounded-full '+syncC+'"></div><span class="text-white text-sm">'+syncT+'</span></div></div><div class="flex items-center gap-4"><div class="text-right hidden sm:block"><p class="text-xs text-purple-300">'+role+'</p><p class="text-white font-semibold">'+this.user.name+'</p>'+grpInfo+'</div><button onclick="app.logout()" class="px-4 py-2 bg-red-500/20 text-red-300 rounded-lg border border-red-500/30">Salir</button></div></div></div></nav><div class="max-w-7xl mx-auto px-4 py-6"><div class="bg-gradient-to-br from-purple-500/20 via-pink-500/20 to-purple-500/20 backdrop-blur-xl rounded-3xl p-6 border border-purple-500/30 mb-6"><div class="flex flex-col md:flex-row justify-between items-start gap-4"><div><p class="text-gray-400 text-sm mb-2">Balance</p><div class="flex items-baseline gap-3"><h2 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-white to-purple-200 font-mono">'+formatNum(this.user.tokens)+'</h2><span class="text-2xl text-purple-300 font-bold">'+BB+'</span></div>'+gradeS+'</div>'+sendBtn+'</div><div class="bg-black/40 rounded-xl p-4 border border-white/10 mt-4"><div class="flex justify-between mb-2"><p class="text-gray-400 text-xs">Wallet</p><button onclick="navigator.clipboard.writeText(\''+this.user.ethAddress+'\');alert(\'Copiado\')" class="text-purple-400 text-xs">Copiar</button></div><code class="text-white font-mono text-sm break-all">'+this.user.ethAddress+'</code></div></div><div class="flex flex-wrap gap-2 mb-6 bg-black/20 p-2 rounded-2xl border border-white/5">'+tabsH+'</div>'+content+'</div>'+(this.modal?this.modalHTML():'');
}

myStudentsPanel(){
const myGroups=this.getMyGroups();
const myStudents=this.getMyStudents();
const totalTokens=myStudents.reduce((a,s)=>a+s.tokens,0);
const avgTokens=myStudents.length?totalTokens/myStudents.length:0;
const pendingPurchases=this.purchases.filter(p=>p.status==='pending'&&myStudents.some(s=>s.id===p.studentId));

// Botones de grupo
let groupBtns='';
myGroups.forEach(gName=>{
const color=GROUP_COLORS[gName]||'#9333ea';
const count=this.getStudentsByGroup(gName).length;
const isActive=this.selectedGroup===gName;
const activeClass=isActive?'ring-2 ring-white ring-offset-2 ring-offset-slate-900':'';
groupBtns+='<button onclick="app.selectGroup(\''+gName+'\')" class="group-btn px-6 py-4 rounded-xl font-bold text-white '+activeClass+'" style="background:'+color+'"><div class="text-2xl">'+gName+'</div><div class="text-sm opacity-80">'+count+' alumnos</div></button>';
});

let groupStats='';
myGroups.forEach(gName=>{
const gStudents=this.getStudentsByGroup(gName);
const gTotal=gStudents.reduce((a,s)=>a+s.tokens,0);
const gAvg=gStudents.length?gTotal/gStudents.length:0;
const color=GROUP_COLORS[gName]||'#9333ea';
groupStats+='<div class="bg-black/30 rounded-xl p-4 border-l-4" style="border-color:'+color+'"><div class="flex justify-between items-center mb-2"><h4 class="text-white font-bold text-lg">'+gName+'</h4><span class="text-xs px-2 py-1 rounded-full" style="background:'+color+'30;color:'+color+'">'+gStudents.length+'</span></div><div class="grid grid-cols-2 gap-2 text-sm"><div><span class="text-gray-400">Total:</span><span class="text-white font-mono ml-2">'+formatNum(gTotal)+'</span></div><div><span class="text-gray-400">Media:</span><span class="text-white font-mono ml-2">'+formatNum(gAvg)+'</span></div></div></div>';
});

const top5=myStudents.sort((a,b)=>b.tokens-a.tokens).slice(0,5);
let top5Html='';
top5.forEach((s,i)=>{
const medal=i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'#'+(i+1);
const color=GROUP_COLORS[s.class]||'#9333ea';
top5Html+='<div class="flex justify-between items-center py-2 border-b border-white/5"><div class="flex items-center gap-2"><span class="text-lg">'+medal+'</span><div><span class="text-white">'+s.name+'</span><span class="text-xs ml-2 px-2 py-0.5 rounded" style="background:'+color+'30;color:'+color+'">'+s.class+'</span></div></div><span class="text-white font-mono">'+formatNum(s.tokens)+'</span></div>';
});

let pendingHtml='';
if(pendingPurchases.length>0){
let items='';
pendingPurchases.forEach(p=>{
items+='<div class="flex justify-between items-center py-2 border-b border-white/5"><div><span class="text-white">'+p.studentName+'</span><span class="text-yellow-300 text-sm ml-2">'+p.rewardName+'</span></div><div class="flex gap-2"><button onclick="app.verifyPurchase(\''+p.id+'\',true)" class="px-3 py-1 bg-green-500/20 text-green-300 rounded text-sm">‚úì</button><button onclick="app.verifyPurchase(\''+p.id+'\',false)" class="px-3 py-1 bg-red-500/20 text-red-300 rounded text-sm">‚úó</button></div></div>';
});
pendingHtml='<div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4 mb-6"><h4 class="text-yellow-300 font-bold mb-3">‚è≥ Compras Pendientes ('+pendingPurchases.length+')</h4><div class="space-y-1">'+items+'</div></div>';
}

return '<div class="space-y-6">'+
'<div class="bg-gradient-to-br from-blue-500/10 to-cyan-500/10 rounded-2xl p-6 border border-blue-500/30">'+
'<h3 class="text-white font-bold text-2xl mb-4">üëã Hola '+this.user.name+'</h3>'+
'<p class="text-gray-400 mb-4">Tus grupos asignados:</p>'+
'<div class="flex flex-wrap gap-4 mb-6">'+groupBtns+'</div>'+
'<div class="grid grid-cols-2 md:grid-cols-4 gap-4">'+
'<div class="bg-black/30 rounded-xl p-4 text-center"><p class="text-gray-400 text-sm">Total Alumnos</p><p class="text-white text-3xl font-bold">'+myStudents.length+'</p></div>'+
'<div class="bg-black/30 rounded-xl p-4 text-center"><p class="text-gray-400 text-sm">Mis Grupos</p><p class="text-white text-3xl font-bold">'+myGroups.length+'</p></div>'+
'<div class="bg-black/30 rounded-xl p-4 text-center"><p class="text-gray-400 text-sm">Total '+BB+'</p><p class="text-green-400 text-2xl font-bold font-mono">'+formatNum(totalTokens)+'</p></div>'+
'<div class="bg-black/30 rounded-xl p-4 text-center"><p class="text-gray-400 text-sm">Media</p><p class="text-purple-400 text-2xl font-bold font-mono">'+formatNum(avgTokens)+'</p></div>'+
'</div>'+
'</div>'+
pendingHtml+
'<div class="grid md:grid-cols-2 gap-6">'+
'<div class="bg-gradient-to-br from-slate-800/50 to-slate-900/50 rounded-2xl p-6 border border-white/10">'+
'<h4 class="text-white font-bold text-lg mb-4">üìä Stats por Grupo</h4>'+
'<div class="space-y-3">'+groupStats+'</div>'+
'</div>'+
'<div class="bg-gradient-to-br from-amber-500/10 to-orange-500/10 rounded-2xl p-6 border border-amber-500/30">'+
'<h4 class="text-white font-bold text-lg mb-4">üèÜ Top 5 Mis Alumnos</h4>'+
'<div class="space-y-1">'+top5Html+'</div>'+
'</div>'+
'</div>'+
'</div>';
}

// PANEL DE ASIGNACION CON SELECTOR DE GRUPO PRIMERO
assignPanel(){
const myGroups=this.getMyGroups();
// Si no hay grupo seleccionado, usar el primero
if(!this.selectedGroup||!myGroups.includes(this.selectedGroup)){
this.selectedGroup=myGroups[0];
}
const students=this.selectedGroup?this.getStudentsByGroup(this.selectedGroup):[];
students.sort((a,b)=>a.name.localeCompare(b.name));

// Botones de grupo grandes y claros
let groupBtns='';
myGroups.forEach(gName=>{
const color=GROUP_COLORS[gName]||'#9333ea';
const count=this.getStudentsByGroup(gName).length;
const isActive=this.selectedGroup===gName;
const style=isActive?'background:'+color+';color:white;':'background:'+color+'20;color:'+color+';border:2px solid '+color+';';
groupBtns+='<button onclick="app.selectGroup(\''+gName+'\')" class="group-btn px-6 py-4 rounded-xl font-bold transition-all '+(isActive?'ring-2 ring-white':'')+'" style="'+style+'"><div class="text-xl">'+gName+'</div><div class="text-sm opacity-80">'+count+' alumnos</div></button>';
});

// Select de alumnos del grupo seleccionado
let sOpts='<option value="">-- Selecciona alumno --</option>';
students.forEach(s=>{sOpts+='<option value="'+s.id+'">'+s.name+' ('+formatNum(s.tokens)+' '+BB+')</option>'});

// Select de tareas
let tOpts='<option value="">-- Selecciona tarea --</option>';
this.tasks.forEach(t=>{tOpts+='<option value="'+t.id+'">'+t.name+' (+'+t.reward+' '+BB+')</option>'});

// Lista de tareas
let tasksHtml='';
this.tasks.forEach(t=>{
tasksHtml+='<div class="bg-white/5 rounded-lg p-3 flex justify-between items-center"><div><p class="text-white font-semibold text-sm">'+t.name+'</p><p class="text-gray-500 text-xs">'+t.category+'</p></div><span class="bg-green-500/20 text-green-300 px-2 py-1 rounded-full font-mono text-xs">+'+t.reward+'</span></div>';
});

const selectedColor=GROUP_COLORS[this.selectedGroup]||'#9333ea';

return '<div class="space-y-6">'+
// Paso 1: Seleccionar grupo
'<div class="bg-gradient-to-br from-slate-800/50 to-slate-900/50 rounded-2xl p-6 border border-white/10">'+
'<h3 class="text-white font-bold text-xl mb-2">1Ô∏è‚É£ Selecciona tu grupo</h3>'+
'<p class="text-gray-400 text-sm mb-4">Haz clic en el grupo donde quieres asignar</p>'+
'<div class="flex flex-wrap gap-4">'+groupBtns+'</div>'+
'</div>'+
// Paso 2: Seleccionar alumno y tarea
'<div class="grid lg:grid-cols-3 gap-6">'+
'<div class="lg:col-span-2 bg-gradient-to-br from-blue-500/10 to-cyan-500/10 rounded-2xl p-6 border border-blue-500/30" style="border-top:4px solid '+selectedColor+'">'+
'<h3 class="text-white font-bold text-xl mb-1">2Ô∏è‚É£ Asignar en <span style="color:'+selectedColor+'">'+this.selectedGroup+'</span></h3>'+
'<p class="text-gray-400 text-sm mb-4">'+students.length+' alumnos disponibles</p>'+
'<div class="space-y-4">'+
'<div><label class="block text-gray-300 text-sm mb-2 font-semibold">Alumno/a</label><select id="sel-s" class="w-full px-4 py-3 border border-white/10 rounded-xl text-white bg-white/5 text-lg">'+sOpts+'</select></div>'+
'<div><label class="block text-gray-300 text-sm mb-2 font-semibold">Tarea</label><select id="sel-t" class="w-full px-4 py-3 border border-white/10 rounded-xl text-white bg-white/5 text-lg">'+tOpts+'</select></div>'+
'<button onclick="app.doAssign()" class="w-full text-white py-4 rounded-xl font-bold text-lg" style="background:linear-gradient(135deg,'+selectedColor+',#ec4899)">‚ö° Asignar '+BB+'</button>'+
'</div>'+
'</div>'+
'<div class="bg-gradient-to-br from-green-500/10 to-emerald-500/10 rounded-2xl p-6 border border-green-500/30">'+
'<h4 class="text-white font-bold text-lg mb-4">üìã Tareas</h4>'+
'<div class="space-y-2 max-h-[350px] overflow-y-auto">'+tasksHtml+'</div>'+
'</div>'+
'</div>'+
'</div>';
}

shopPanel(){
const cats=[...new Set(this.shop.map(i=>i.cat))];
const mp=this.user.role==='student'?this.purchases.filter(p=>p.studentId===this.user.id):this.purchases;
const bal=this.user.role==='student'?'<div class="bg-black/30 px-4 py-2 rounded-xl"><span class="text-gray-400 text-sm">Saldo:</span><span class="text-white font-mono font-bold ml-2">'+formatNum(this.user.tokens)+' '+BB+'</span></div>':'';
let catsH='';
cats.forEach(cat=>{
const items=this.shop.filter(i=>i.cat===cat);
let itemsH='';
items.forEach(item=>{
const warn=item.stock<=10?'<span class="text-xs px-2 py-1 rounded-full bg-red-500/20 text-red-300">'+item.stock+'</span>':'';
const op=item.stock<=0?'opacity-50':'';
let btn='';
if(this.user.role==='student'){
const can=item.stock>0&&this.user.tokens>=item.price;
const cls=item.stock<=0?'bg-gray-500/20 text-gray-500':can?'bg-emerald-500/20 text-emerald-300':'bg-gray-500/20 text-gray-500';
const dis=can?'':'disabled';
const txt=item.stock<=0?'Agotado':'Comprar';
btn='<button onclick="app.buyReward(\''+item.id+'\')" class="px-3 py-1 rounded-lg text-sm '+cls+'" '+dis+'>'+txt+'</button>';
}else{btn='<span class="text-gray-400 text-xs">Stock: '+item.stock+'</span>';}
itemsH+='<div class="bg-black/30 rounded-xl p-4 border border-white/10 card-hover '+op+'"><div class="flex justify-between items-start mb-2"><h5 class="text-white font-semibold text-sm">'+item.name+'</h5>'+warn+'</div><p class="text-gray-400 text-xs mb-3">'+item.desc+'</p><div class="flex justify-between items-center"><span class="text-emerald-300 font-mono font-bold">'+formatNum(item.price)+' '+BB+'</span>'+btn+'</div></div>';
});
catsH+='<div class="mb-6"><h4 class="text-emerald-300 font-semibold mb-3">'+cat+'</h4><div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">'+itemsH+'</div></div>';
});
let purchH='';
if(mp.length>0){
let pItems='';
const max=Math.min(10,mp.length);
for(let i=0;i<max;i++){
const p=mp[i];
const sInfo=this.user.role==='tutor'?'<p class="text-white font-semibold">'+p.studentName+'</p>':'';
const stCls=p.status==='verified'?'bg-green-500/20 text-green-300':p.status==='pending'?'bg-yellow-500/20 text-yellow-300':'bg-red-500/20 text-red-300';
const stTxt=p.status==='verified'?'‚úì':p.status==='pending'?'‚è≥':'‚úó';
pItems+='<div class="bg-black/30 rounded-lg p-3 flex justify-between items-center"><div>'+sInfo+'<p class="text-purple-300 text-sm">'+p.rewardName+'</p></div><span class="text-xs px-2 py-1 rounded-full '+stCls+'">'+stTxt+'</span></div>';
}
purchH='<div class="bg-gradient-to-br from-purple-500/10 to-pink-500/10 rounded-2xl p-6 border border-purple-500/30"><h4 class="text-white font-bold mb-4">'+(this.user.role==='student'?'Mis Compras':'Historial')+'</h4><div class="space-y-2">'+pItems+'</div></div>';
}
return '<div class="space-y-6"><div class="bg-gradient-to-br from-emerald-500/10 to-teal-500/10 rounded-2xl p-6 border border-emerald-500/30"><div class="flex justify-between items-center mb-6"><h3 class="text-white font-bold text-2xl">üõí Tienda</h3>'+bal+'</div>'+catsH+'</div>'+purchH+'</div>';
}

gradesPanel(){
const myGroups=this.getMyGroups();
if(!this.selectedGroup||!myGroups.includes(this.selectedGroup)){
this.selectedGroup=myGroups[0];
}
const students=this.selectedGroup?this.getStudentsByGroup(this.selectedGroup):[];
students.sort((a,b)=>b.tokens-a.tokens);

let groupBtns='';
myGroups.forEach(gName=>{
const color=GROUP_COLORS[gName]||'#9333ea';
const isActive=this.selectedGroup===gName;
const style=isActive?'background:'+color+';color:white;':'background:'+color+'20;color:'+color+';';
groupBtns+='<button onclick="app.selectGroup(\''+gName+'\')" class="px-4 py-2 rounded-lg font-semibold '+'" style="'+style+'">'+gName+'</button>';
});

let rows='';
students.forEach((s,i)=>{
const color=GROUP_COLORS[s.class]||'#9333ea';
rows+='<tr class="border-b border-white/5 hover:bg-white/5"><td class="py-3 px-2 text-gray-500">'+(i+1)+'</td><td class="py-3 px-2"><p class="text-white font-semibold">'+s.name+'</p><p class="text-gray-500 text-xs font-mono">'+s.nick+'</p></td><td class="py-3 px-2 text-right font-mono text-white">'+formatNum(s.tokens)+'</td><td class="py-3 px-2 text-right"><span class="bg-green-500/20 text-green-300 px-3 py-1 rounded-full">+'+this.grade(s.tokens)+'</span></td></tr>';
});

const selectedColor=GROUP_COLORS[this.selectedGroup]||'#9333ea';

return '<div class="bg-gradient-to-br from-amber-500/10 to-orange-500/10 rounded-2xl p-6 border border-amber-500/30">'+
'<div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">'+
'<div><h3 class="text-white font-bold text-2xl">üìã Calificaciones</h3><p class="text-amber-300 text-sm mt-1">'+RATIO+' '+BB+' = 0.1 puntos</p></div>'+
'<div class="flex gap-2">'+groupBtns+'</div>'+
'</div>'+
'<div class="mb-4 p-3 rounded-lg" style="background:'+selectedColor+'20;border-left:4px solid '+selectedColor+'"><span class="text-white font-bold">'+this.selectedGroup+'</span><span class="text-gray-300 ml-2">'+students.length+' alumnos</span></div>'+
'<div class="overflow-x-auto"><table class="w-full"><thead><tr class="border-b border-white/10"><th class="text-left text-gray-400 text-sm py-3 px-2">#</th><th class="text-left text-gray-400 text-sm py-3 px-2">Alumno</th><th class="text-right text-gray-400 text-sm py-3 px-2">'+BB+'</th><th class="text-right text-gray-400 text-sm py-3 px-2">Pts</th></tr></thead><tbody>'+rows+'</tbody></table></div>'+
'<div class="mt-4 text-center"><button onclick="app.exportCSV()" class="px-6 py-3 bg-amber-500/20 text-amber-300 rounded-xl font-semibold">üì• Exportar CSV</button></div>'+
'</div>';
}

exportCSV(){
const students=this.selectedGroup?this.getStudentsByGroup(this.selectedGroup):[];
students.sort((a,b)=>a.name.localeCompare(b.name));
let csv='Nick,Nombre,Grupo,BraiBits,Puntos\n';
students.forEach(s=>{csv+=s.nick+','+s.name+','+s.class+','+s.tokens+','+this.grade(s.tokens)+'\n'});
const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
const link=document.createElement('a');
link.href=URL.createObjectURL(blob);
link.download='calificaciones_'+this.selectedGroup+'_'+new Date().toISOString().split('T')[0]+'.csv';
link.click();
}

studentPanel(){
let tasksHtml='';
this.tasks.forEach(t=>{tasksHtml+='<div class="bg-white/5 rounded-xl p-4 border border-white/10"><div class="flex justify-between items-center"><div><p class="text-white font-semibold">'+t.name+'</p><p class="text-gray-400 text-xs">'+t.category+'</p></div><span class="bg-green-500/20 text-green-300 px-3 py-1 rounded-full font-mono font-bold">+'+t.reward+' '+BB+'</span></div></div>'});
const myTx=this.txs.filter(t=>t.from===this.user.ethAddress||t.to===this.user.ethAddress).length;
return '<div class="grid md:grid-cols-2 gap-6"><div class="bg-gradient-to-br from-green-500/10 to-emerald-500/10 rounded-2xl p-6 border border-green-500/30"><h3 class="text-white font-bold text-xl mb-4">üìã Tareas Disponibles</h3><div class="space-y-2">'+tasksHtml+'</div></div><div class="bg-gradient-to-br from-purple-500/10 to-pink-500/10 rounded-2xl p-6 border border-purple-500/30"><h3 class="text-white font-bold text-xl mb-4">üë§ Mi Info</h3><div class="space-y-3"><div class="flex justify-between"><span class="text-gray-400">Nick:</span><span class="text-white font-mono">'+this.user.nick+'</span></div><div class="flex justify-between"><span class="text-gray-400">Clase:</span><span class="text-white">'+this.user.class+'</span></div><div class="flex justify-between"><span class="text-gray-400">Puntos:</span><span class="text-green-400">+'+this.grade(this.user.tokens)+'</span></div><div class="flex justify-between"><span class="text-gray-400">Transacciones:</span><span class="text-white font-mono">'+myTx+'</span></div></div></div></div>';
}

rankingPanel(){
const ss=this.users.filter(u=>u.role==='student').sort((a,b)=>b.tokens-a.tokens);
const pos=ss.findIndex(s=>s.id===this.user.id)+1;
let rows='';
const max=Math.min(50,ss.length);
for(let i=0;i<max;i++){
const s=ss[i];
const m=i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'#'+(i+1);
const me=s.id===this.user.id;
const ring=me?'ring-2 ring-purple-500':'';
const meTxt=me?' (Tu)':'';
const color=GROUP_COLORS[s.class]||'#9333ea';
rows+='<div class="bg-white/5 rounded-lg p-3 flex justify-between items-center '+ring+'"><div class="flex items-center gap-3"><span class="text-2xl w-10 text-center">'+m+'</span><div><p class="text-white font-semibold">'+s.name+meTxt+'</p><p class="text-xs px-2 py-0.5 rounded inline-block" style="background:'+color+'30;color:'+color+'">'+s.class+'</p></div></div><p class="text-white font-mono font-bold">'+formatNum(s.tokens)+' '+BB+'</p></div>';
}
return '<div class="space-y-6"><div class="bg-gradient-to-r from-amber-500/20 to-orange-500/20 rounded-2xl p-6 border border-amber-500/30"><div class="flex items-center justify-between"><div><p class="text-amber-300 text-sm">Tu posicion</p><p class="text-white text-4xl font-bold font-mono">#'+pos+'</p></div><div class="text-right"><p class="text-amber-300 text-sm">De '+ss.length+' alumnos</p><p class="text-white text-2xl font-bold font-mono">'+formatNum(this.user.tokens)+' '+BB+'</p></div></div></div><div class="bg-gradient-to-br from-purple-500/10 to-pink-500/10 rounded-2xl p-6 border border-purple-500/30"><h3 class="text-white font-bold text-2xl mb-4">üèÜ Ranking</h3><div class="space-y-2 max-h-[500px] overflow-y-auto">'+rows+'</div></div></div>';
}

historyPanel(){
const myGroups=this.getMyGroups();
const myStudents=this.getMyStudents();
let mt;
if(this.user.role==='tutor'){
mt=this.txs.filter(tx=>myStudents.some(s=>s.id===tx.toId||s.id===tx.fromId));
}else{
mt=this.txs.filter(t=>t.from===this.user.ethAddress||t.to===this.user.ethAddress);
}
let txH='';
if(mt.length===0){txH='<p class="text-gray-400 text-center py-8">Sin transacciones</p>';}
else{let items='';mt.slice(0,50).forEach(tx=>{items+=this.txItem(tx)});txH='<div class="space-y-3 max-h-[600px] overflow-y-auto">'+items+'</div>';}
return '<div class="bg-gradient-to-br from-purple-500/10 to-pink-500/10 rounded-2xl p-6 border border-purple-500/30"><div class="flex justify-between items-center mb-4"><h3 class="text-white font-bold text-2xl">üìú Historial</h3><span class="text-gray-400 text-sm">'+mt.length+' tx</span></div>'+txH+'</div>';
}

txItem(tx){
const isRec=tx.to===this.user.ethAddress;
const isRev=tx.reversed;
const isRevTx=tx.type==='reversal';
const showRev=this.user.role==='tutor'&&!isRev&&!isRevTx&&tx.type==='task_reward';
let border=isRev?'border-gray-500/30':isRevTx?'border-yellow-500/30':'border-green-500/30';
let color=isRevTx?'text-yellow-400':'text-green-400';
let icon=isRevTx?'‚Ü©Ô∏è':'üì•';
const revBadge=isRev?'<span class="px-2 py-1 bg-red-500/20 text-red-300 rounded text-xs ml-2">ANULADA</span>':'';
const op=isRev?'opacity-50':'';
const line=isRev?'line-through':'';
const revBtn=showRev?'<button onclick="app.openModal(\'revert\',\''+tx.id+'\')" class="mt-2 px-3 py-1 bg-red-500/20 text-red-300 rounded text-xs">‚Ü©Ô∏è Revertir</button>':'';
return '<div class="bg-white/5 rounded-xl p-4 border '+border+' '+op+'"><div class="flex justify-between items-start"><div><div class="flex items-center mb-1"><p class="font-bold '+color+'">'+icon+' '+tx.description+'</p>'+revBadge+'</div><p class="text-gray-400 text-sm">'+tx.toName+'</p><p class="text-gray-500 text-xs">'+formatDate(tx.timestamp)+'</p></div><div class="text-right"><p class="text-white font-mono text-lg font-bold '+line+'">+'+formatNum(tx.netAmount)+' '+BB+'</p>'+revBtn+'</div></div></div>';
}

modalHTML(){
let content='';
if(this.modal==='transfer'){
const ss=this.users.filter(u=>u.role==='student'&&u.id!==this.user.id).sort((a,b)=>a.class.localeCompare(b.class)||a.name.localeCompare(b.name));
let opts='<option value="">-- Selecciona --</option>';
ss.forEach(s=>{opts+='<option value="'+s.id+'">'+s.name+' ('+s.class+')</option>'});
content='<h3 class="text-white font-bold text-xl mb-4">üí∏ Enviar '+BB+'</h3><div class="space-y-4"><div><label class="block text-gray-300 text-sm mb-2">Destinatario</label><select id="tr-to" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white">'+opts+'</select></div><div><label class="block text-gray-300 text-sm mb-2">Cantidad</label><input type="number" id="tr-amt" min="1" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white font-mono"><p class="text-gray-500 text-xs mt-1">Disponible: '+formatNum(this.user.tokens)+' (gas: 0.1%)</p></div><div><label class="block text-gray-300 text-sm mb-2">Mensaje</label><input type="text" id="tr-msg" placeholder="Opcional" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white"></div></div><div class="flex gap-3 mt-6"><button onclick="app.closeModal()" class="flex-1 px-4 py-3 bg-white/5 text-gray-300 rounded-xl">Cancelar</button><button onclick="app.doTransfer()" class="flex-1 px-4 py-3 bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-xl font-bold">Enviar</button></div>';
}else if(this.modal==='revert'){
const tx=this.txs.find(t=>t.id===this.modalData);
if(tx){
const student=this.users.find(u=>u.id===tx.toId);
const sBalance=student?student.tokens:0;
const canRevert=sBalance>=tx.netAmount;
const warning=canRevert?'':'<div class="bg-red-500/20 border border-red-500/30 rounded-lg p-3 mb-4"><p class="text-red-300 text-sm">‚ö†Ô∏è Saldo insuficiente ('+formatNum(sBalance)+' '+BB+')</p></div>';
const btnClass=canRevert?'bg-gradient-to-r from-red-500 to-orange-500 text-white':'bg-gray-500/20 text-gray-500';
content='<h3 class="text-white font-bold text-xl mb-4">‚Ü©Ô∏è Revertir</h3>'+warning+'<div class="bg-black/30 rounded-xl p-4 mb-4"><p class="text-white font-semibold">'+tx.description+'</p><p class="text-gray-400 text-sm">Alumno: '+tx.toName+'</p><p class="text-red-400 font-mono font-bold text-lg mt-2">-'+formatNum(tx.netAmount)+' '+BB+'</p></div><div class="flex gap-3"><button onclick="app.closeModal()" class="flex-1 px-4 py-3 bg-white/5 text-gray-300 rounded-xl">Cancelar</button><button onclick="app.revertTx(\''+tx.id+'\')" class="flex-1 px-4 py-3 '+btnClass+' rounded-xl font-bold" '+(canRevert?'':'disabled')+'>Confirmar</button></div>';
}
}
return '<div class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4" onclick="if(event.target===this)app.closeModal()"><div class="bg-slate-900 rounded-2xl p-6 max-w-md w-full border border-purple-500/30">'+content+'</div></div>';
}

events(){
const f=document.getElementById('login-form');
if(f){f.onsubmit=e=>{e.preventDefault();const isS=document.getElementById('btn-s').classList.contains('bg-gradient-to-r');if(isS)this.login('student',{nick:document.getElementById('nick').value.toUpperCase(),password:document.getElementById('pass').value});else this.login('tutor',{email:document.getElementById('email').value,password:document.getElementById('pass-t').value})};}
}

switchType(type){
const bs=document.getElementById('btn-s'),bt=document.getElementById('btn-t'),fs=document.getElementById('f-student'),ft=document.getElementById('f-tutor');
if(type==='student'){bs.className='flex-1 py-3 rounded-xl font-semibold bg-gradient-to-r from-purple-500 to-pink-500 text-white';bt.className='flex-1 py-3 rounded-xl font-semibold bg-white/5 text-gray-300';fs.classList.remove('hidden');ft.classList.add('hidden');}
else{bt.className='flex-1 py-3 rounded-xl font-semibold bg-gradient-to-r from-purple-500 to-pink-500 text-white';bs.className='flex-1 py-3 rounded-xl font-semibold bg-white/5 text-gray-300';ft.classList.remove('hidden');fs.classList.add('hidden');}
}

doAssign(){const sId=document.getElementById('sel-s').value,tId=document.getElementById('sel-t').value;if(!sId||!tId){alert('Selecciona alumno y tarea');return}this.assignTask(sId,tId)}
doTransfer(){const toId=document.getElementById('tr-to').value,amt=parseFloat(document.getElementById('tr-amt').value),msg=document.getElementById('tr-msg').value;if(!toId){alert('Selecciona destinatario');return}if(!amt||amt<=0){alert('Cantidad invalida');return}this.transferP2P(toId,amt,msg)}
}

const app=new App();
</script>
</body>
</html>
